<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API - Grades (Fixed v2)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .controls {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .controls h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        button {
            padding: 12px 24px;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .status-info {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .status-success { background: #4CAF50; color: white; }
        .status-error { background: #f44336; color: white; }
        .status-loading { background: #FF9800; color: white; }
        
        .stats-box {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stats-box h3 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 8px;
        }
        
        .stat-item small {
            display: block;
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-item strong {
            display: block;
            font-size: 32px;
            color: #667eea;
            font-weight: bold;
        }
        
        .grade-card {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .grade-card:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .grade-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .grade-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .grade-info-item {
            padding: 10px;
            background: #f5f7fa;
            border-radius: 6px;
        }
        
        .grade-info-item strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .score-display {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            margin: 20px 0;
            color: white;
        }
        
        .score-display .score {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .score-display .percentage {
            font-size: 24px;
            opacity: 0.9;
        }
        
        .feedback-box {
            background: #FFF3E0;
            border-left: 4px solid #FF9800;
            padding: 20px;
            margin-top: 15px;
            border-radius: 6px;
        }
        
        .feedback-box strong {
            color: #FF9800;
            display: block;
            margin-bottom: 10px;
        }
        
        #result {
            background: #263238;
            color: #A5D6A7;
            padding: 20px;
            border-radius: 12px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 500px;
            overflow-y: auto;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #c62828;
            margin: 20px 0;
        }
        
        .warning-message {
            background: #fff3e0;
            color: #e65100;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #ff9800;
            margin: 20px 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Test API - Grades (ƒêi·ªÉm s·ªë) v2</h1>
        
        <div class="status-info">
            <span class="status-badge status-loading" id="statusBadge">Ch∆∞a test</span>
            <span id="statusText">Ch·ªçn m·ªôt test case ƒë·ªÉ b·∫Øt ƒë·∫ßu</span>
        </div>
        
        <div class="controls">
            <h3>Ch·ªçn test case:</h3>
            <div class="button-group">
                <button onclick="getGradesByStudent(4)">‚úÖ ƒêi·ªÉm c·ªßa Student1 (ID=4)</button>
                <button onclick="getGradesByStudent(5)">‚úÖ ƒêi·ªÉm c·ªßa Student2 (ID=5)</button>
                <button onclick="getGradesByCourse(4, 1)">‚úÖ Student1 - Kh√≥a PHP-101</button>
                <button onclick="getGradesByCourse(4, 2)">‚ö†Ô∏è Student1 - Kh√≥a JS-201 (Ch∆∞a n·ªôp b√†i)</button>
                <button onclick="testInvalidStudent()">‚ö†Ô∏è Test student kh√¥ng t·ªìn t·∫°i</button>
                <button onclick="testMissingParam()">‚ö†Ô∏è Test thi·∫øu parameter</button>
            </div>
        </div>
        
        <div id="grades-container"></div>
        
        <div class="controls">
            <h3>üìÑ Raw JSON Response:</h3>
            <div id="result">Ch∆∞a c√≥ d·ªØ li·ªáu...</div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost/online-learning/api/grades.php';
        
        function updateStatus(type, message) {
            const badge = document.getElementById('statusBadge');
            const text = document.getElementById('statusText');
            
            badge.className = 'status-badge status-' + type;
            badge.textContent = type === 'success' ? '‚úÖ Success' : type === 'error' ? '‚ùå Error' : '‚è≥ Loading';
            text.textContent = message;
        }
        
        function callAPI(params) {
            const url = `${API_URL}?${params}`;
            
            updateStatus('loading', 'ƒêang g·ªçi API: ' + url);
            document.getElementById('grades-container').innerHTML = '<div class="loading">ƒêang t·∫£i d·ªØ li·ªáu</div>';
            
            fetch(url)
                .then(response => {
                    // QUAN TR·ªåNG: Lu√¥n parse JSON b·∫•t k·ªÉ HTTP status code
                    return response.json().then(data => ({
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok,
                        data: data
                    }));
                })
                .then(result => {
                    const data = result.data;
                    
                    // Hi·ªÉn th·ªã JSON response
                    document.getElementById('result').textContent = JSON.stringify(data, null, 2);
                    
                    // Ki·ªÉm tra k·∫øt qu·∫£
                    if(result.ok && data.success) {
                        // HTTP 200 + success: true
                        updateStatus('success', `‚úÖ ${data.message} (HTTP ${result.status})`);
                        displayGrades(data);
                    } else if(!result.ok && data.success === false) {
                        // HTTP 400/404 + success: false (Expected error)
                        updateStatus('error', `‚ö†Ô∏è ${data.message} (HTTP ${result.status})`);
                        displayExpectedError(data, result.status);
                    } else {
                        // Unexpected error
                        updateStatus('error', `‚ùå L·ªói kh√¥ng x√°c ƒë·ªãnh (HTTP ${result.status})`);
                        displayError(data);
                    }
                })
                .catch(error => {
                    // Network error ho·∫∑c parse JSON error
                    updateStatus('error', 'üí• L·ªói k·∫øt n·ªëi: ' + error.message);
                    document.getElementById('result').textContent = 'Network Error: ' + error.message;
                    document.getElementById('grades-container').innerHTML = `
                        <div class="error-message">
                            <strong>üí• L·ªói nghi√™m tr·ªçng</strong>
                            <p>${error.message}</p>
                            <small>Ki·ªÉm tra xem server ƒë√£ ch·∫°y ch∆∞a (XAMPP MySQL + Apache)</small>
                        </div>
                    `;
                });
        }
        
        function displayGrades(data) {
            const container = document.getElementById('grades-container');
            
            if(data.data && data.data.length > 0) {
                const stats = data.statistics;
                
                let html = `
                    <div class="stats-box">
                        <h3>üìä Th·ªëng k√™ t·ªïng quan - Student ID: ${data.student_id}</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <small>T·ªïng s·ªë b√†i</small>
                                <strong>${stats.total_assignments}</strong>
                            </div>
                            <div class="stat-item">
                                <small>ƒê√£ ch·∫•m</small>
                                <strong>${stats.graded_assignments}</strong>
                            </div>
                            <div class="stat-item">
                                <small>Ch∆∞a ch·∫•m</small>
                                <strong>${stats.ungraded_assignments}</strong>
                            </div>
                            <div class="stat-item">
                                <small>ƒêi·ªÉm trung b√¨nh</small>
                                <strong>${stats.average_score}</strong>
                            </div>
                            <div class="stat-item">
                                <small>T·ªïng ƒëi·ªÉm</small>
                                <strong>${stats.total_score} / ${stats.total_max_score}</strong>
                            </div>
                            <div class="stat-item">
                                <small>Ph·∫ßn trƒÉm</small>
                                <strong>${stats.percentage}%</strong>
                            </div>
                        </div>
                    </div>
                `;
                
                html += '<h2 style="color: white; margin: 20px 0;">üìù Chi ti·∫øt t·ª´ng b√†i t·∫≠p</h2>';
                
                data.data.forEach((item, index) => {
                    const statusEmoji = {
                        'graded': '‚úÖ',
                        'submitted': '‚è≥',
                        'late': '‚ö†Ô∏è'
                    }[item.status] || '‚ùì';
                    
                    const statusText = {
                        'graded': 'ƒê√£ ch·∫•m',
                        'submitted': 'Ch·ªù ch·∫•m',
                        'late': 'N·ªôp tr·ªÖ'
                    }[item.status] || item.status;
                    
                    html += `
                        <div class="grade-card">
                            <h3>${index + 1}. ${item.assignment_title}</h3>
                            
                            <div class="grade-info">
                                <div class="grade-info-item">
                                    <strong>üìö Kh√≥a h·ªçc</strong>
                                    ${item.course_name}
                                </div>
                                <div class="grade-info-item">
                                    <strong>üìÖ N·ªôp l√∫c</strong>
                                    ${new Date(item.submit_date).toLocaleString('vi-VN')}
                                </div>
                                <div class="grade-info-item">
                                    <strong>üìä Tr·∫°ng th√°i</strong>
                                    ${statusEmoji} ${statusText}
                                </div>
                            </div>
                    `;
                    
                    if(item.score !== null) {
                        const percentage = ((item.score / item.max_score) * 100).toFixed(1);
                        html += `
                            <div class="score-display">
                                <div class="score">${item.score} / ${item.max_score}</div>
                                <div class="percentage">${percentage}%</div>
                            </div>
                        `;
                        
                        if(item.feedback) {
                            html += `
                                <div class="feedback-box">
                                    <strong>üí¨ Nh·∫≠n x√©t c·ªßa gi·∫£ng vi√™n:</strong>
                                    <p>${item.feedback}</p>
                                    <small style="color: #999;">Ch·∫•m l√∫c: ${new Date(item.graded_at).toLocaleString('vi-VN')}</small>
                                </div>
                            `;
                        }
                    } else {
                        html += `
                            <div class="score-display" style="background: #FF9800;">
                                <div class="score">‚è≥</div>
                                <div class="percentage">Ch∆∞a ch·∫•m ƒëi·ªÉm</div>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                });
                
                container.innerHTML = html;
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        <h3>Ch∆∞a c√≥ d·ªØ li·ªáu</h3>
                        <p>H·ªçc vi√™n n√†y ch∆∞a n·ªôp b√†i t·∫≠p n√†o</p>
                    </div>
                `;
            }
        }
        
        function displayExpectedError(data, httpStatus) {
            const container = document.getElementById('grades-container');
            
            let icon = '‚ö†Ô∏è';
            let title = 'Expected Error';
            let bgClass = 'warning-message';
            
            if(httpStatus === 404) {
                icon = 'üîç';
                title = 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu (404)';
            } else if(httpStatus === 400) {
                icon = '‚ùå';
                title = 'Y√™u c·∫ßu kh√¥ng h·ª£p l·ªá (400)';
                bgClass = 'error-message';
            }
            
            container.innerHTML = `
                <div class="${bgClass}">
                    <strong>${icon} ${title}</strong>
                    <p>${data.message}</p>
                    <small>ƒê√¢y l√† l·ªói mong ƒë·ª£i (expected error) - API ho·∫°t ƒë·ªông ƒë√∫ng!</small>
                </div>
            `;
        }
        
        function displayError(data) {
            const container = document.getElementById('grades-container');
            container.innerHTML = `
                <div class="error-message">
                    <strong>‚ùå L·ªói kh√¥ng x√°c ƒë·ªãnh</strong>
                    <p>${data.message || 'API tr·∫£ v·ªÅ l·ªói kh√¥ng r√µ nguy√™n nh√¢n'}</p>
                    <small>Ki·ªÉm tra console ƒë·ªÉ xem chi ti·∫øt</small>
                </div>
            `;
        }
        
        function getGradesByStudent(studentId) {
            callAPI(`student_id=${studentId}`);
        }
        
        function getGradesByCourse(studentId, courseId) {
            callAPI(`student_id=${studentId}&course_id=${courseId}`);
        }
        
        function testInvalidStudent() {
            callAPI('student_id=9999');
        }
        
        function testMissingParam() {
            callAPI('');
        }
        
        // Auto load khi trang m·ªü
        window.onload = function() {
            getGradesByStudent(4);
        };
    </script>
</body>
</html>